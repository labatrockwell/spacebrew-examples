<!DOCTYPE HTML>
<html>
	<head>
		<title>Spacebrew Chat</title>
		<meta charset="utf-8">
		<link rel="stylesheet" href="css/style.css" type="text/css" media="screen" charset="utf-8" />
		<!-- basic libraries -->
        <script type="text/javascript" src="js/jquery/jq.js"></script>
<script type="text/javascript">
$(document).ready( function() {
	setup();
});

function gup( name ) {
  name = name.replace(/[\[]/,"\\\[").replace(/[\]]/,"\\\]");
  var regexS = "[\\?&]"+name+"=([^&#]*)";
  var regex = new RegExp( regexS );
  var results = regex.exec( window.location.href );
  if( results == null )
    return "";
  else
    return results[1];
}

var name = gup('name') || window.location.href; 
var server = gup('server') || 'localhost';


var index = 0;

var myConfig = {
"config": {
 "name": name,
 "description": "A simple and whimsical chat client",
 "publish": {
   "messages": [
     {
       "name": "send",
       "type": "string",
       "default": "hello"
     }
   ]
 },
 "subscribe": {
   "messages": [
     {
       "name": "receive",
       "type": "string"
     }
   ]
 }
}
};

var ws;
function setupWS(){
  ws = new WebSocket("ws://"+server+":9000");
    ws.onopen = function() {
        console.log("WebSockets connection opened");
        var nameMsg = { "name": [
        	{"name": name}
       	]};
   		ws.send(JSON.stringify(nameMsg));

      // send my config
      ws.send(JSON.stringify(myConfig));
      if (gup('ping')){
        setInterval(ws.send(''), 60*1000);
      }
    }
    ws.onmessage = function(e) {
      var data = JSON.parse(e.data);

        var currName = data.message.name;
        var currType = data.message.type;
        var currValue = data.message.value;

        if (currType == "string") {
          addText("them", currValue);
        }
    }
    ws.onclose = function() {
        console.log("WebSockets connection closed");
    }
  };


//-------------------------------------------------------
function setup (){

  document.getElementById("btnSend").addEventListener('click',sendMessage);
  setupWS();
}

function addText(from, text){
  var wrapper = document.createElement("div");
  wrapper.classList.add("text");

  var user = document.createElement("div");
  user.classList.add("from");
  user.innerText = from;
  //wrapper.appendChild(user);

  var content = document.createElement("div");
  content.classList.add("content");
  if (text.length > 0){
    var upper = text[0].toUpperCase();
    if ('A' <= upper && upper <= 'Z'){
      content.innerHTML = "<div class='from'>"+from+":</div><span class='drop "+upper+Math.floor(Math.random()*13)+"'>"+upper+"</span>"+text.substring(1); 
    } else {
      content.innerHTML = "div class='from'>"+from+":</div>"+text;
    }
  }
  if (text.toUpperCase)
  
  wrapper.appendChild(content);

  var all = document.querySelector("#txtReceive");
  all.insertBefore(wrapper, all.firstChild);
}

function sendMessage(e){
  e = e || window.event;
  if (e)e.preventDefault();
  addText("me", document.getElementById("txtSend").value);
  console.log("sending");
  ws.send(JSON.stringify({
    message:{
      clientName:name,
      name:"send",
      type:"string",
      value:document.getElementById("txtSend").value
    }
  }));
  return false;
};

</script>
		<!-- MAIN -->
	</head>
	<body>
    <textarea id="txtSend" rows='4' cols='60'></textarea>
    <button id="btnSend" type='submit'>send</button>
    <div id="txtReceive">
      <div class='legal'>drop caps provided by http://www.dailydropcap.com</div><div>
  </body>
</html>