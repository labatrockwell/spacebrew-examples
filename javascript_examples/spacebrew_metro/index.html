<!DOCTYPE HTML>
<html>
	<head>
		<title>Spacebrew Metro</title>
		<meta charset="utf-8">
		<link rel="stylesheet" href="css/reset.css" type="text/css" media="screen" charset="utf-8" />
		<link rel="stylesheet" href="css/style.css" type="text/css" media="screen" charset="utf-8" />
		<!-- basic libraries -->
        <script type="text/javascript" src="js/jquery/jq.js"></script>
<script type="text/javascript">
$(document).ready( function() {
	setupws();
});

function gup( name ) {
  name = name.replace(/[\[]/,"\\\[").replace(/[\]]/,"\\\]");
  var regexS = "[\\?&]"+name+"=([^&#]*)";
  var regex = new RegExp( regexS );
  var results = regex.exec( window.location.href );
  if( results == null )
    return "";
  else
    return results[1];
}

var index = 0;

var name = gup('name') || "metro"; 
var server = gup('server') || 'localhost';
var delay = parseInt(gup('delay'));
var currInterval;

console.log(name);

var myConfig = {
"config": {
 "name": name,
 "description": "This outputs a boolean every so often.",
 "publish": {
   "messages": [
    {
      "name": "bang",
      "type": "boolean",
      "default": true
    }
   ]
 },
 "subscribe": {
   "messages": [
     {
       "name": "delay",
       "type": "number"
     },
     {
      "name": "sync",
      "type": "boolean"
     }
   ]
 }
}
};

var ws;
var setupws = function(){
  ws = new WebSocket("ws://"+server+":9000");
    ws.onopen = function() {
        console.log("WebSockets connection opened");
        if (delay == delay){
          setDelay(delay);
        } else {
          //NaN
          document.getElementById("output").innerHTML = "Send a number message to set metro delay.";
        }
        var nameMsg = { "name": [
        	{"name": name}
       	]};
   		ws.send(JSON.stringify(nameMsg));

      // send my config
      ws.send(JSON.stringify(myConfig));
    }
    ws.onmessage = function(e) {
        console.log("Got WebSockets message: " + e.data);
        

        var currName = JSON.parse(e.data).message.name;
        var currType = JSON.parse(e.data).message.type;
        var currValue = JSON.parse(e.data).message.value;
        
        // if itâ€™s a text
        if (currName == "delay") {
          console.log("received number");
          var v = parseInt(currValue);
          if (v == v) {
            delay = v;
            setDelay(delay);
          }
        } else if (currName == "sync"){
          setDelay(delay);
          sendBang();
        }
    }
    ws.onclose = function() {
        console.log("WebSockets connection closed");
        document.getElementById("output").innerHTML = "no longer connected to spacebrew :(";
    }
};

function setDelay(d){
  clearInterval(currInterval);
  currInterval = setInterval(sendBang, d);
  document.getElementById('output').innerHTML = "sending bang every " + d + " milliseconds";
}

function sendBang(){
  var message = {message:
       {
           clientName:name,
           name:"bang",
           type:"boolean",
           value:"true"
       }
    };

  //console.log(message);
  ws.send(JSON.stringify(message));
};

</script>
		<!-- MAIN -->
	</head>
	<body>
		<h3 id="output">Not Connected to Spacebrew :(</h3>
   </body>
</html>